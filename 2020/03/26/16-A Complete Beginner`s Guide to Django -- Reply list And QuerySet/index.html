<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="A Complete Beginner`s Guide to Django -- Reply list And QuerySet"><meta name="keywords" content="Django, afrunk"><link rel="alternate" href="/default" title="afrunk"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="http://afrunk.github.io/2020/03/26/16-A Complete Beginner`s Guide to Django -- Reply list And QuerySet/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css"><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":true};
</script>

    <title>A Complete Beginner`s Guide to Django -- Reply list And QuerySet - afrunk</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">afrunk</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archivew
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/MachineLearning/">
        <li class="mobile-menu-item">机器学习
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">afrunk</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archivew
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/MachineLearning/">
            机器学习
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">A Complete Beginner`s Guide to Django -- Reply list And QuerySet
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-03-26
        </span><span class="post-category">
            <a href="/categories/Django-Tutorial/">Django Tutorial</a>
            </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#保护视图"><span class="toc-text">保护视图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置登录后的重定向地址"><span class="toc-text">配置登录后的重定向地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#已登录用户发言"><span class="toc-text">已登录用户发言</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#主题回复列表"><span class="toc-text">主题回复列表</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#路由跳转"><span class="toc-text">路由跳转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#展示回复"><span class="toc-text">展示回复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#回复功能"><span class="toc-text">回复功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#QuerySet"><span class="toc-text">QuerySet</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#外键查询"><span class="toc-text">外键查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#跨表无外键查询"><span class="toc-text">跨表无外键查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#筛选查询并排序"><span class="toc-text">筛选查询并排序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方法构建和模板调用"><span class="toc-text">方法构建和模板调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更简单查询"><span class="toc-text">更简单查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改主题的查看次数"><span class="toc-text">修改主题的查看次数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusions"><span class="toc-text">Conclusions</span></a></li></ol>
    </div>
  </div><div class="post-content"><p>保护视图防止未登录的用户访问，以及在视图和表单中访问已经登录的用户，我们还将实现主题列表和回复列表视图，最后将探索 Django ORM 的一些特性 和数据迁移的简单介绍。<br><a id="more"></a></p>
<h1 id="保护视图"><a href="#保护视图" class="headerlink" title="保护视图"></a>保护视图</h1><p>我们必须保护视图防止那些未认证（登录）的用户访问，下面是发起一个新话题的页面。</p>
<p>我们在 view 视图中添加一个视图装饰器来避免它被未登录的用户访问，如果新建 Topic 的话就会被重定向到登录页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">boards/views.py</span><br><span class="line"></span><br><span class="line">from django.contrib.auth.decorators import login_required</span><br><span class="line"># 避免它被未登录的用户访问</span><br><span class="line">@login_required</span><br><span class="line"># 新建 topic 的函数</span><br><span class="line">def new_topic(request,pk):</span><br><span class="line">    # ...</span><br></pre></td></tr></table></figure>
<p><img src="1.png" alt></p>
<h2 id="配置登录后的重定向地址"><a href="#配置登录后的重定向地址" class="headerlink" title="配置登录后的重定向地址"></a>配置登录后的重定向地址</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">templates/login.html</span><br><span class="line"></span><br><span class="line">&lt;form method=<span class="string">"post"</span> novalidate&gt;</span><br><span class="line">  &#123;% csrf_token %&#125;</span><br><span class="line">    &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"next"</span> value=<span class="string">"&#123;&#123; next &#125;&#125;"</span>&gt;</span><br><span class="line">  &#123;% include <span class="string">'includes/form.html'</span> %&#125;</span><br><span class="line">  &lt;button type="submit" class="btn btn-primary btn-block"&gt;Log in&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>现在尝试登录，登录成功后，应用程序就会跳转到原来的位置，<code>next</code> 也是内置功能的一部分。有关 <code>next</code> 的具体应用可以参考 <a href="https://afrunk.github.io/2020/03/22/9-Django-%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD/#Part-5-%E6%B3%A8%E9%94%80%E5%92%8C%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC">Django 注册登录功能-跳转功能</a></p>
<h2 id="已登录用户发言"><a href="#已登录用户发言" class="headerlink" title="已登录用户发言"></a>已登录用户发言</h2><p>现在我们可以改进之前的 new_topic 视图，将发布主题的用户设置为当前登录的用户，取代之前直接从数据库查询出来的第一个用户，之前这份代码是临时的，因为那时候还没有方法去获取登录用户，但是现在可以了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">boards/views.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> NewTopicForm</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="comment"># 避免它被未登录的用户访问</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="comment"># 新建 topic 的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_topic</span><span class="params">(request,pk)</span>:</span></span><br><span class="line">    board = get_object_or_404(Board,pk=pk)</span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">'POST'</span>:</span><br><span class="line">        <span class="comment"># 如果是 POST 请求 则将请求传入表单</span></span><br><span class="line">        form = NewTopicForm(request.POST)</span><br><span class="line">        <span class="comment"># 如果表单的请求是有效的 则使用 form.save() 存入数据库</span></span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            <span class="comment"># save方法返回的一个存入数据库的 Model 实例</span></span><br><span class="line">            <span class="comment"># 因为这是一个 Topic form 所以会创建一个 Topic</span></span><br><span class="line">            topic = form.save(commit=<span class="literal">False</span>)</span><br><span class="line">            topic.board=board</span><br><span class="line">            topic.starter = request.user <span class="comment"># &lt;- hrer</span></span><br><span class="line">            topic.save()</span><br><span class="line"></span><br><span class="line">            post = Post.objects.create(</span><br><span class="line">                message = form.cleaned_data.get(<span class="string">'message'</span>),</span><br><span class="line">                topic = topic,</span><br><span class="line">                created_by=request.user <span class="comment"># and here</span></span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># 重定向</span></span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'board_topics2'</span>,pk=board.pk)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = NewTopicForm()</span><br><span class="line">    <span class="comment"># 如果数据是无效的 ，django 会给 form 添加错误列表</span></span><br><span class="line">    <span class="comment"># 然后 视图函数不会做任何处理并且原本的表单页面 并显示错误</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'new_topic.html'</span>,&#123;<span class="string">'board'</span>:board,<span class="string">'form'</span>:form&#125;)</span><br></pre></td></tr></table></figure>
<p>我们添加一个新的主题快速验证一下：</p>
<p><img src="2.png" alt></p>
<h1 id="主题回复列表"><a href="#主题回复列表" class="headerlink" title="主题回复列表"></a>主题回复列表</h1><h2 id="路由跳转"><a href="#路由跳转" class="headerlink" title="路由跳转"></a>路由跳转</h2><p>现在我们花点时间来实现主题的回复列表页面，先来看一下线框图</p>
<p><img src="3.png" alt></p>
<p>首先我们需要写 URL 路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myproject/urls.py</span><br><span class="line"></span><br><span class="line"># 回复列表路由</span><br><span class="line">path(&apos;boards/&lt;int:pk&gt;/topics/&lt;int:topic_pk&gt;/&apos;,views.topic_posts,name=&apos;topic_posts&apos;)</span><br></pre></td></tr></table></figure>
<p>有两个关键字参数，<code>pk</code> 用于唯一标识版块 Board，<code>topic_pk</code> 用于唯一标识该回复来自哪个主题。将这2个数传入给视图函数，视图函数查询数据库数据，然后将数据模型返回给前端页面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">boards/views.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回复列表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">topic_posts</span><span class="params">(request,pk,topic_pk)</span>:</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    topic = get_object_or_404(Topic,board__pk=pk,pk=topic_pk)</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'topic_posts.html'</span> ,&#123;<span class="string">'topic'</span>:topic&#125;)</span><br></pre></td></tr></table></figure>
<p>这些和我们之前的在 <a href="https://afrunk.github.io/2020/03/24/14-A%20Complete%20Beginner%60s%20Guide%20to%20Django%20--%20Advanced%20Concepts/#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE">服务器如何获取数据</a> 中提到了类似的方法。</p>
<p>但是需要注意，这里视图函数传给前端的是 Topic Model ,所以我们在前端中想要查询 board Model 的信息的话就需要使用 <code>topic.board.name</code> 的外键访问形式来进行。在上面的文章中，传给前端的是 board Model ，如果要访问 Topic Model 的信息使用的就是 <code>for topic in board.topics.all</code>。 这就是外键的反向链接，再比如我们要访问 post Model 中的内容，也可以使用外键来访问 <code></code>。注意上面的语句，在 HTML 页面中也需要双括号括起来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">templates/topic_posts.html</span><br><span class="line"></span><br><span class="line">&#123;% extends <span class="string">'base.html'</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;&#123;&#123; topic.subject &#125;&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">  &lt;li class="breadcrumb-item"&gt;&lt;a href="&#123;% url 'home' %&#125;"&gt;Boards&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">  &lt;li class="breadcrumb-item"&gt;&lt;a href="&#123;% url 'board_topics' topic.board.pk %&#125;"&gt;&#123;&#123; topic.board.name &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">  &lt;li class="breadcrumb-item active"&gt;&#123;&#123; topic.subject &#125;&#125;&lt;/li&gt;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以输入 <code>http://127.0.0.1:8000/boards/1/topics/1/</code> 访问到如下的页面</p>
<p><img src="4.png" alt></p>
<p>但是我们需要可以通过点击帖子的方法来访问到页面，即在这个页面可以点击帖子，所以我们需要修改 <code>topic.html</code> 的路由跳转</p>
<p><img src="5.png" alt></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">templates/topics.html</span><br><span class="line"></span><br><span class="line">&lt;td&gt;&lt;a href="&#123;% url 'topic_posts' board.id topic.id %&#125;"&gt;&#123;&#123; topic.subject &#125;&#125;&lt;/a&gt;&lt;/td&gt;</span><br></pre></td></tr></table></figure>
<p><img src="6.png" alt></p>
<h2 id="展示回复"><a href="#展示回复" class="headerlink" title="展示回复"></a>展示回复</h2><p>ok ，现在我们可以很方便的进入到回复的页面，现在就是将所有的回复都展示出来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">templates/topic_posts.html</span><br><span class="line"></span><br><span class="line">&#123;% extends &apos;base.html&apos; %&#125;</span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line">&#123;% block title %&#125;&#123;&#123; topic.subject &#125;&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">  &lt;li class=&quot;breadcrumb-item&quot;&gt;&lt;a href=&quot;&#123;% url &apos;home&apos; %&#125;&quot;&gt;Boards&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">  &lt;li class=&quot;breadcrumb-item&quot;&gt;&lt;a href=&quot;&#123;% url &apos;board_topics2&apos; topic.board.pk %&#125;&quot;&gt;&#123;&#123; topic.board.name &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">  &lt;li class=&quot;breadcrumb-item active&quot;&gt;&#123;&#123; topic.subject &#125;&#125;&lt;/li&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"></span><br><span class="line">     &lt;div class=&quot;mb-4&quot;&gt;</span><br><span class="line">        &lt;a href=&quot;#&quot; class=&quot;btn btn-primary&quot; role=&quot;button&quot;&gt;Reply&lt;/a&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">  &#123;% for post in topic.post_set.all %&#125;</span><br><span class="line">    &lt;div class=&quot;card mb-2&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;card-body p-3&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">          &lt;div class=&quot;col-2&quot;&gt;</span><br><span class="line">            &lt;img src=&quot;&#123;% static &apos;img/3.png&apos; %&#125;&quot; alt=&quot;&#123;&#123; post.created_by.username &#125;&#125;&quot; class=&quot;w-100&quot;&gt;</span><br><span class="line">            &lt;small&gt;Posts: &#123;&#123; post.created_by.posts.count &#125;&#125;&lt;/small&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class=&quot;col-10&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;row mb-3&quot;&gt;</span><br><span class="line">              &lt;div class=&quot;col-6&quot;&gt;</span><br><span class="line">                &lt;strong class=&quot;text-muted&quot;&gt;&#123;&#123; post.created_by.username &#125;&#125;&lt;/strong&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">              &lt;div class=&quot;col-6 text-right&quot;&gt;</span><br><span class="line">                &lt;small class=&quot;text-muted&quot;&gt;&#123;&#123; post.created_at &#125;&#125;&lt;/small&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &#123;&#123; post.message &#125;&#125;</span><br><span class="line">            &#123;% if post.created_by == user %&#125;</span><br><span class="line">              &lt;div class=&quot;mt-3&quot;&gt;</span><br><span class="line">                &lt;a href=&quot;#&quot; class=&quot;btn btn-primary btn-sm&quot; role=&quot;button&quot;&gt;Edit&lt;/a&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们引入了一张图片，我们需要去到 <a href="https://www.iconfinder.com/search/?q=user&amp;license=2&amp;price=free" target="_blank" rel="noopener">CONFINDER</a> 下载一个用户头像,然后保存在项目的 <code>static/img</code> 目录下。</p>
<p>我们这里来理解下上面的代码。首先，在 Django 2.2 中使用 topic 与 post 的外键反作用需要使用 <code>for post in topic.post_set.all</code> 才能获取到所有 topic 下的 post。然后我们就可以通过 <code>post.created_by.username</code> 访问回复用户名，<code>post.created_at</code> 可以查创建时间，<code>post.message</code> 可以获取回复内容。</p>
<p>另外，在 HTML 文件中我们进行了判断这个 Post 是否是当前用户回复的，如果是才可以进行编辑<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if post.created_by == user %&#125;</span><br><span class="line">  &lt;div class=&quot;mt-3&quot;&gt;</span><br><span class="line">    &lt;a href=&quot;#&quot; class=&quot;btn btn-primary btn-sm&quot; role=&quot;button&quot;&gt;Edit&lt;/a&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="7.png" alt></p>
<h2 id="回复功能"><a href="#回复功能" class="headerlink" title="回复功能"></a>回复功能</h2><p>现在让我们来实现回复帖子的功能，以便我们可以添加更多的数据和改进功能。</p>
<p><img src="8.png" alt></p>
<p>添加新的路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myproject/urls.py</span><br><span class="line"></span><br><span class="line"># 添加新的回复</span><br><span class="line">path(&apos;boards/&lt;int:pk&gt;/topics/&lt;int:topic_pk&gt;/reply/&apos;,views.reply_topic,name=&apos;reply_topic&apos;)</span><br></pre></td></tr></table></figure>
<p>为回帖回复创建一个新的表单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">boards/forms.py</span><br><span class="line"></span><br><span class="line">from django import forms</span><br><span class="line">from .models import Topic,Post</span><br><span class="line"></span><br><span class="line">class NewTopicForm(forms.ModelForm):</span><br><span class="line">    message = forms.CharField(</span><br><span class="line">        widget=forms.Textarea(</span><br><span class="line">            attrs=&#123;&apos;rows&apos;:5,&apos;placeholder&apos;:&apos;what is on your mind?&apos;&#125;</span><br><span class="line">            # 输入框内的文本</span><br><span class="line">        ),max_length=4000,</span><br><span class="line">        help_text=&apos;The max length of the text is 4000.&apos;</span><br><span class="line">        # 提示文本</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        model = Topic</span><br><span class="line">        fields =[&apos;subject&apos;,&apos;message&apos;]</span><br><span class="line"></span><br><span class="line">class PostForm(forms.ModelForm):</span><br><span class="line">    class Meta:</span><br><span class="line">        model = Post</span><br><span class="line">        fields = [&apos;message&apos;,]</span><br></pre></td></tr></table></figure>
<p>再来补充 <code>reply_topic</code> 视图</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">boards/views.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加回复</span></span><br><span class="line"><span class="comment"># 防止未登录的用户进行添加</span></span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> PostForm</span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reply_topic</span><span class="params">(request,pk,topic_pk)</span>:</span></span><br><span class="line">    <span class="comment"># 获取 topic 的内容</span></span><br><span class="line">    topic = get_object_or_404(Topic,board__pk=pk,pk=topic_pk)</span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">'POST'</span>:</span><br><span class="line">        form = PostForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            post = form.save(commit=<span class="literal">False</span>)</span><br><span class="line">            post.topic = topic</span><br><span class="line">            post.created_by = request.user</span><br><span class="line">            post.save()</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'topic_posts'</span>,pk=pk,topic_pk=topic_pk)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = PostForm()</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'reply_topic.html'</span>,&#123;<span class="string">'topic'</span>:topic,<span class="string">'form'</span>:form&#125;)</span><br></pre></td></tr></table></figure>
<p>然后我们需要修改之前的 New_topic 的跳转地址，修改回 topic 的回复列表页</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">boards/views.py</span><br><span class="line"></span><br><span class="line"># 重定向</span><br><span class="line">return redirect(&apos;topic_posts&apos;,pk=pk,topic_pk=topic.pk)</span><br></pre></td></tr></table></figure>
<p>需要注意：在视图函数中 replay_topic 中，我们使用的 topic_pk，因为引用的是函数的关键字参数，而在 new_topic 视图中，我们使用的是 topic.pk ，因为 topic 是一个对象，<code>.pk</code> 是这个实例对象的一个属性，这两种细微的差别，其实区别很大，别搞混了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">templates/reply_topic.html</span><br><span class="line"></span><br><span class="line">&#123;% extends <span class="string">'base.html'</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Post a reply&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">  &lt;li class="breadcrumb-item"&gt;&lt;a href="&#123;% url 'home' %&#125;"&gt;Boards&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">  &lt;li class="breadcrumb-item"&gt;&lt;a href="&#123;% url 'board_topics2' topic.board.pk %&#125;"&gt;&#123;&#123; topic.board.name &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">  &lt;li class="breadcrumb-item"&gt;&lt;a href="&#123;% url 'topic_posts' topic.board.pk topic.pk %&#125;"&gt;&#123;&#123; topic.subject &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">  &lt;li class="breadcrumb-item active"&gt;Post a reply&lt;/li&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"></span><br><span class="line">  &lt;form method="post" class="mb-4"&gt;</span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    &#123;% include <span class="string">'includes/form.html'</span> %&#125;</span><br><span class="line">    &lt;button type="submit" class="btn btn-success"&gt;Post a reply&lt;/button&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">  &#123;% <span class="keyword">for</span> post <span class="keyword">in</span> topic.posts.all %&#125;</span><br><span class="line">    &lt;div class="card mb-2"&gt;</span><br><span class="line">      &lt;div class="card-body p-3"&gt;</span><br><span class="line">        &lt;div class="row mb-3"&gt;</span><br><span class="line">          &lt;div class="col-6"&gt;</span><br><span class="line">            &lt;strong class="text-muted"&gt;&#123;&#123; post.created_by.username &#125;&#125;&lt;/strong&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class="col-6 text-right"&gt;</span><br><span class="line">            &lt;small class="text-muted"&gt;&#123;&#123; post.created_at &#125;&#125;&lt;/small&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &#123;&#123; post.message &#125;&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>然后，去修改 replay 按钮的路由，以便跳转到新建回复的页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">templates/topic_posts.html</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;mb-4&quot;&gt;</span><br><span class="line">    &lt;a href=&quot;&#123;% url &apos;reply_topic&apos; topic.pk topic.board.pk%&#125;&quot; class=&quot;btn btn-primary&quot; role=&quot;button&quot;&gt;Reply&lt;/a&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p><img src="9.png" alt></p>
<p>添加之后，我们就可以在列表页看到回复的所有内容了。</p>
<p><img src="10.png" alt></p>
<p>让我们的第一条回复变得与众不同</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">templates/topic_posts.html</span><br><span class="line"></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">    &#123;<span class="comment">#      黑色边框#&#125;</span></span><br><span class="line">    &lt;div class="card mb-2 &#123;% if forloop.first %&#125;border-dark&#123;% endif %&#125;"&gt;</span><br><span class="line">    &#123;<span class="comment">#黑色上边距#&#125;</span></span><br><span class="line">    &#123;% <span class="keyword">if</span> forloop.first %&#125;</span><br><span class="line">      &lt;div class="card-header text-white bg-dark py-2 px-3"&gt;&#123;&#123; topic.subject &#125;&#125;&lt;/div&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    <span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p><img src="11.png" alt></p>
<h1 id="QuerySet"><a href="#QuerySet" class="headerlink" title="QuerySet"></a>QuerySet</h1><p>现在我们花点时间来探索关于模型的 API。首先，我们来改进主页</p>
<p><img src="12.png" alt></p>
<ul>
<li>显示每个版块的总主题数</li>
<li>显示每个版块的总回复数</li>
<li>显示每个版块的最后发布者和日期</li>
</ul>
<p>为了尝试实现这些功能，我们会用到 Python 终端，所以把所有的 models 定义一个 <strong>str</strong> 方法是个好主意。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">boards/models.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 模块</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Board</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 帖子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Topic</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.subject</span><br><span class="line"><span class="comment"># 回复</span></span><br><span class="line"><span class="keyword">from</span>  django.utils.text <span class="keyword">import</span> Truncator</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        truncated_message = Truncator(self.message)</span><br><span class="line">        <span class="keyword">return</span> truncated_message.chars(<span class="number">30</span>)</span><br></pre></td></tr></table></figure>
<p>在 Post 模型中，使用了 <code>Truncator</code> 工具类，这是将一个长字符串截取任意长度字符的简便方法（这里我们使用30个字符）</p>
<h2 id="外键查询"><a href="#外键查询" class="headerlink" title="外键查询"></a>外键查询</h2><p>现在打开 python shell,最简单的一个就是获取当前版块的总主题数，因为 Topic 和 Board 是直接关联的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">2</span>]: <span class="keyword">from</span> boards.models <span class="keyword">import</span> Board</span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: board = Board.objects.get(name=<span class="string">'Django'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: board.topics.all()</span><br><span class="line">Out[<span class="number">4</span>]: &lt;QuerySet [&lt;Topic: Hello everyone!&gt;, &lt;Topic: Django 跨表查询&gt;, &lt;Topic: 用户测试 Django&gt;, &lt;Topic: admin4&gt;, &lt;Topic: Hello everyone!&gt;, &lt;Topic: afrunk 发布的内容&gt;]&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: board.topics.count()</span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">6</span></span><br></pre></td></tr></table></figure>
<h2 id="跨表无外键查询"><a href="#跨表无外键查询" class="headerlink" title="跨表无外键查询"></a>跨表无外键查询</h2><p>要统计一个版块下面的回复数量有点麻烦，因为回复并没有和 Board 进行关联。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">8</span>]: <span class="keyword">from</span> boards.models <span class="keyword">import</span> Post</span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: Post.objects.all()</span><br><span class="line">Out[<span class="number">9</span>]: </span><br><span class="line">&lt;QuerySet [&lt;Post: This <span class="keyword">is</span> my first topic!</span><br><span class="line">&gt;, &lt;Post: 首先要注意连接外键，这样子虽然不好理解，board.topi&gt;, &lt;Post: This <span class="keyword">is</span> Test!&gt;, &lt;Post: 这也是系统的一部分&gt;, &lt;Post: 还是测试&gt;, &lt;Post: <span class="number">1</span>&gt;, &lt;Post: this <span class="keyword">is</span> test!&gt;, &lt;Post: 这还是测试！&gt;]&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里获取的是所有的回复 并不全部属于 Django 这个版块</span></span><br><span class="line">In [<span class="number">10</span>]: Post.objects.count()</span><br><span class="line">Out[<span class="number">10</span>]: <span class="number">8</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">11</span>]: <span class="keyword">from</span> boards.models <span class="keyword">import</span> Board,Post</span><br><span class="line"></span><br><span class="line">In [<span class="number">12</span>]: board = Board.objects.get(name=<span class="string">'Django'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 双下划线的 topic__board 用于通过模型关系来定位</span></span><br><span class="line"><span class="comment"># 在内部，Django 在 Board-Topic-Post 之间构建了桥梁</span></span><br><span class="line"><span class="comment"># 构建SQL 查询来获取属于指定版块下面的帖子回复</span></span><br><span class="line">In [<span class="number">13</span>]: Post.objects.filter(topic__board=board)</span><br><span class="line">Out[<span class="number">13</span>]: </span><br><span class="line">&lt;QuerySet [&lt;Post: This <span class="keyword">is</span> my first topic!</span><br><span class="line">&gt;, &lt;Post: 这还是测试！&gt;, &lt;Post: 首先要注意连接外键，这样子虽然不好理解，board.topi&gt;, &lt;Post: 这也是系统的一部分&gt;, &lt;Post: 还是测试&gt;, &lt;Post: <span class="number">1</span>&gt;, &lt;Post: this <span class="keyword">is</span> test!&gt;]&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">14</span>]: Post.objects.filter(topic__board=board).count()</span><br><span class="line">Out[<span class="number">14</span>]: <span class="number">7</span></span><br></pre></td></tr></table></figure>
<h2 id="筛选查询并排序"><a href="#筛选查询并排序" class="headerlink" title="筛选查询并排序"></a>筛选查询并排序</h2><p>如何标识版块下面的最后一条回复,通过排序的方法来筛选数据，并输出排序后的第一条数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [15]: Post.objects.filter(topic__board=board).order_by(&apos;-created_at&apos;)</span><br><span class="line">Out[15]: </span><br><span class="line">&lt;QuerySet [&lt;Post: 这还是测试！&gt;, &lt;Post: this is test!&gt;, &lt;Post: 1&gt;, &lt;Post: 还是测试&gt;, &lt;Post: 这也是系统的一部分&gt;, &lt;Post: 首先要注意连接外键，这样子虽然不好理解，board.topi&gt;, &lt;Post: This is my first topic!</span><br><span class="line">&gt;]&gt;</span><br><span class="line"></span><br><span class="line">In [16]: Post.objects.filter(topic__board=board).order_by(&apos;-created_at&apos;).first()</span><br><span class="line">Out[16]: &lt;Post: 这还是测试！&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="方法构建和模板调用"><a href="#方法构建和模板调用" class="headerlink" title="方法构建和模板调用"></a>方法构建和模板调用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 模块</span><br><span class="line">boards/models.py</span><br><span class="line"></span><br><span class="line">class Board(models.Model):</span><br><span class="line">    # unique= True 强调数据库级别字段的唯一性</span><br><span class="line">    # 必须添加 default 否则会报错告诉你必须添加默认值</span><br><span class="line">    name = models.CharField(max_length=30,unique=True,default=&apos;test&apos;)</span><br><span class="line">    description = models.CharField(max_length=100)</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.name</span><br><span class="line"></span><br><span class="line">    # 定义两个方法 稍后在 HTML 模板中进行调用</span><br><span class="line">    def get_posts_count(self):</span><br><span class="line">        # 使用 self 是 class Board 的一个实例方法</span><br><span class="line">        return Post.objects.filter(topic__board=self).count()</span><br><span class="line"></span><br><span class="line">    def get_last_post(self):</span><br><span class="line">        return Post.objects.filter(topic__board=self).order_by(&apos;-created_at&apos;).first()</span><br></pre></td></tr></table></figure>
<p>这部分的关键在于 HTML 模板的填充。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">templates/home.html</span><br><span class="line"></span><br><span class="line">&#123;% extends &apos;base.html&apos; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">    &lt;li class=&quot;breadcrumb-item active&quot;&gt;Boards&lt;/li&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">&lt;table class=&quot;table&quot;&gt;</span><br><span class="line">    &lt;thead class=&quot;thead-inverse&quot;&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;Board&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;Posts&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;Topics&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;Last Post&lt;/th&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &lt;/thead&gt;</span><br><span class="line">    &lt;tbody&gt;</span><br><span class="line">    &#123;% for board in boards %&#125;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;a href=&quot;&#123;% url &apos;board_topics2&apos; board.pk %&#125;&quot;&gt;&#123;&#123; board.name &#125;&#125;&lt;/a&gt;</span><br><span class="line">                &lt;small class=&quot;text-muted d-block&quot;&gt;&#123;&#123; board.description &#125;&#125;&lt;/small&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td class=&quot;align-middle&quot;&gt;&#123;&#123; board.get_posts_count &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td class=&quot;align-middle&quot;&gt;&#123;&#123; board.get_last_post &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td class=&quot;align-middle&quot;&gt;</span><br><span class="line">                &#123;%  with  post=board.get_last_post %&#125;</span><br><span class="line">                    &#123;% if  post %&#125;</span><br><span class="line">                      &lt;small&gt;</span><br><span class="line">                        &lt;a href=&quot;&#123;% url &apos;topic_posts&apos; board.pk post.topic.pk %&#125;&quot;&gt;</span><br><span class="line">                          By &#123;&#123; post.created_by.username &#125;&#125; at &#123;&#123; post.created_at &#125;&#125;</span><br><span class="line">                        &lt;/a&gt;</span><br><span class="line">                      &lt;/small&gt;</span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                &#123;% endwith %&#125;</span><br><span class="line">          &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    &lt;/tbody&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看看视图的配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def home(request):</span><br><span class="line">    boards = Board.objects.all()# 从数据库中读取 board 表内的数据</span><br><span class="line">    return render(request,&apos;home.html&apos;,&#123;&apos;boards&apos;:boards&#125;)</span><br></pre></td></tr></table></figure></p>
<p>首页传给前端模板的 Model 是 Board,我们要所以如果我们要获取 Topic 的内容和跳转链接的话，需要使用如下的语句才能实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> # 通过调用 board 的函数获取排序第一个 post </span><br><span class="line"> &#123;%  with  post=board.get_last_post %&#125;</span><br><span class="line">    # 判断是否有帖子</span><br><span class="line">    &#123;% if  post %&#125;</span><br><span class="line">      &lt;small&gt;</span><br><span class="line">      # 如果有的话进行展示</span><br><span class="line">      # 连接 topic_posts 路由 传入两个 pk 值方便跳转</span><br><span class="line">        &lt;a href=&quot;&#123;% url &apos;topic_posts&apos; board.pk post.topic.pk %&#125;&quot;&gt;</span><br><span class="line">          By &#123;&#123; post.created_by.username &#125;&#125; at &#123;&#123; post.created_at &#125;&#125;</span><br><span class="line">        &lt;/a&gt;</span><br><span class="line">      &lt;/small&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&#123;% endwith %&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下</p>
<p><img src="13.png" alt></p>
<h2 id="更简单查询"><a href="#更简单查询" class="headerlink" title="更简单查询"></a>更简单查询</h2><p>现在，我将告诉你另外一种方法来统计回复的数量，用一种更高效的方式和之前一样，首先在 Python shell 中尝试</p>
<p>这个方法是使用 SQL 的语法来操作数据进行展示，推荐大家直接看<a href="https://simpleisbetterthancomplex.com/series/2017/10/02/a-complete-beginners-guide-to-django-part-5.html#querysets" target="_blank" rel="noopener">原文</a>吧。</p>
<h2 id="修改主题的查看次数"><a href="#修改主题的查看次数" class="headerlink" title="修改主题的查看次数"></a>修改主题的查看次数</h2><p>这样子的话我们就需要添加一个新的字段，进入 <code>boards/models.py</code> 添加一个 <code>views</code> 字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class Topic(models.Model):</span><br><span class="line">    subject = models.CharField(max_length=255)</span><br><span class="line">    last_updated = models.DateField(auto_now_add=True)</span><br><span class="line">    # Board 可以通过 related_name 参数用于创建反向关系</span><br><span class="line">    # 访问属于该板块下的 Topic 列表</span><br><span class="line">    board =models.ForeignKey(Board,related_name=&apos;topics&apos;,on_delete=models.CASCADE)</span><br><span class="line">    starter= models.ForeignKey(User,related_name=&apos;topics&apos;,on_delete=models.CASCADE)</span><br><span class="line">    views = models.PositiveIntegerField(default =0) #&lt;-here 默认值为0</span><br><span class="line"></span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.subject</span><br></pre></td></tr></table></figure>
<p>我们添加了一个 <code>PositiveIntegerField</code> , 因为这个字段将要存储的是页面的浏览量，不可能是一个负数。在我们可以使用这个新字段前，我们必须更新数据库 schema，执行命令 <code>makemigrations</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(base) myproject&gt;python manage.py makemigrations</span><br><span class="line">Migrations for &apos;boards&apos;:</span><br><span class="line">  boards\migrations\0003_topic_views.py</span><br><span class="line">    - Add field views to topic</span><br><span class="line"></span><br><span class="line">(base) myproject&gt;python manage.py migrate</span><br><span class="line">Operations to perform:</span><br><span class="line">  Apply all migrations: admin, auth, boards, contenttypes, sessions</span><br><span class="line">Running migrations:</span><br><span class="line">  Applying boards.0003_topic_views... OK</span><br></pre></td></tr></table></figure>
<p>配置好字段之后在视图函数中，每请求一次视图函数则浏览量自加1。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">boards/views.py</span><br><span class="line"></span><br><span class="line">#...</span><br><span class="line"></span><br><span class="line">from django.shortcuts import render,get_object_or_404,redirect</span><br><span class="line">from .models import Board,Topic</span><br><span class="line">def topic_posts(request, pk, topic_pk):</span><br><span class="line">    topic = get_object_or_404(Topic, board__pk=pk, pk=topic_pk)</span><br><span class="line">    # 尝试使用外键的反方向操作来读取 post 里面的内容</span><br><span class="line">    for post in topic.post_set.all():</span><br><span class="line">        print(post.message)</span><br><span class="line">    topic.views +=1</span><br><span class="line">    topic.save()</span><br><span class="line">    return render(request, &apos;topic_posts.html&apos;, &#123;&apos;topic&apos;: topic&#125;)</span><br></pre></td></tr></table></figure>
<p>在前端 HTML 页面中添加浏览量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">templates/topics.html</span><br><span class="line"></span><br><span class="line"> &lt;tbody&gt;</span><br><span class="line">    &#123;% for topic in board.topics.all %&#125;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;&lt;a href=&quot;&#123;% url &apos;topic_posts&apos; board.id topic.id %&#125;&quot;&gt;&#123;&#123; topic.subject &#125;&#125;&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123; topic.starter.username &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;0&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123; topic.views &#125;&#125;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&#123;&#123; topic.last_updated &#125;&#125;&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&lt;/tbody&gt;</span><br></pre></td></tr></table></figure>
<p><img src="14.png" alt></p>
<h1 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h1><p>这部分，我们完成了限制未登录用户发言重定向至登录页面、主题回复列表信息展示、回复功能，最关键的是实现了 QuerySet 视图函数编写和前端 HTML 文件的配合。如何使用外键来正向和反向查询，如何跨表构建链接查询。</p>

      </div>
      
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/Django/">Django</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2020/03/27/17-A Complete Beginner`s Guide to Django -- Class-Based  Views/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">A Complete Beginner`s Guide to Django -- Class-Based  Views</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    <a class="next" href="/2020/03/25/15-A Complete Beginner`s Guide to Django -- User module/">
        <span class="next-text nav-default">A Complete Beginner`s Guide to Django -- User module</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:afrunk7@gmail.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/afrunk" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2019 - 2021<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Afrunk</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
