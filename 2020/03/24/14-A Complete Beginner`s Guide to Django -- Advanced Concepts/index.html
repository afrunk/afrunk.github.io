<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="A Complete Beginner`s Guide to Django -- Advanced Concepts"><meta name="keywords" content="Django, afrunk"><link rel="alternate" href="/default" title="afrunk"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="http://afrunk.github.io/2020/03/24/14-A Complete Beginner`s Guide to Django -- Advanced Concepts/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css"><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":true};
</script>

    <title>A Complete Beginner`s Guide to Django -- Advanced Concepts - afrunk</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">afrunk</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archivew
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/MachineLearning/">
        <li class="mobile-menu-item">机器学习
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">afrunk</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archivew
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/MachineLearning/">
            机器学习
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">A Complete Beginner`s Guide to Django -- Advanced Concepts
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-03-24
        </span><span class="post-category">
            <a href="/categories/Django-Tutorial/">Django Tutorial</a>
            </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#URLs"><span class="toc-text">URLs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#path"><span class="toc-text">path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由跳转"><span class="toc-text">路由跳转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-object-or-404"><span class="toc-text">get_object_or_404</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#模板复用"><span class="toc-text">模板复用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Forms"><span class="toc-text">Forms</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#自己实现表单"><span class="toc-text">自己实现表单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务器如何获取数据"><span class="toc-text">服务器如何获取数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跨表查询"><span class="toc-text">跨表查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#外键"><span class="toc-text">外键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路由跳转-New-Topic"><span class="toc-text">路由跳转 New Topic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-Forms-创建表单"><span class="toc-text">使用 Forms 创建表单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#美化表单"><span class="toc-text">美化表单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusions"><span class="toc-text">Conclusions</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li></ol>
    </div>
  </div><div class="post-content"><p>该部分将深入理解两个基本概念：URLS 、Forms 和模板复用 。在这个过程中，我们还将学习其他很多概念，如创建可重用模板和安装第三方库。</p>
<a id="more"></a>
<h1 id="URLs"><a href="#URLs" class="headerlink" title="URLs"></a>URLs</h1><p>随着项目的开发，我们需要实现一个新的功能，就是列出某个版块下的所有主题列表，再来回顾下，你可以看到 <a href="https://afrunk.github.io/2020/03/23/11-A-Complete-Beginner-s-Guide-to-Django/">A Complete Beginner`s Guide to Django — Models Fundamentals</a> 中我们画的线框图，我们点击 Django 发现连接后面多了一个 Django ，这种效果是如何实现的呢？</p>
<p><img src="1.png" alt></p>
<p>我们看看之前的路由配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">myproject/urls.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 boards APP 中导入 views</span></span><br><span class="line"><span class="keyword">from</span> boards <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'admin/'</span>, admin.site.urls),</span><br><span class="line">    <span class="comment"># 调用views.home</span></span><br><span class="line">    path(<span class="string">''</span>,views.home,name=<span class="string">'home'</span>),</span><br><span class="line">    path(<span class="string">'jsrender'</span>,views.jsrender,name=<span class="string">'jsrender'</span>), <span class="comment"># jsrender 传递参数</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>相较于原本教程，由于 Django 升级了路由语法，在 Django 2.0 开始引入了 <code>django.urls.path</code>，运行使用一种更加简单、可读的路由语法。</p>
<h2 id="path"><a href="#path" class="headerlink" title="path"></a>path</h2><p>标准语法：<code>path(route, view, kwargs=None, name=None</code></p>
<ul>
<li><code>route</code> 表示路径，从端口以后的 URL 地址到结束</li>
<li><code>view</code> 表示 route 匹配成功后，需要调用的视图</li>
<li><code>name</code> 表示别名</li>
<li><code>kwargs</code> 表示一个字典，传给view 函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">myproject/urls.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,re_path</span><br><span class="line"><span class="comment"># 从 boards APP 中导入 views</span></span><br><span class="line"><span class="keyword">from</span> boards <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'admin/'</span>, admin.site.urls),</span><br><span class="line">    <span class="comment"># 调用views.home</span></span><br><span class="line">    path(<span class="string">''</span>,views.home,name=<span class="string">'home'</span>),</span><br><span class="line">    <span class="comment"># 修改为 django 2.0 的 path 路由方法</span></span><br><span class="line">    path(<span class="string">'boards/&lt;int:pk&gt;/'</span>,views.board_topics,name=<span class="string">'board_topics'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">boards/views.py</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">board_topics</span><span class="params">(request,pk)</span>:</span></span><br><span class="line">    <span class="comment"># 通过 pk 主键即 id 来匹配数据库的数据</span></span><br><span class="line">    board = Board.objects.get(pk=pk)</span><br><span class="line">    <span class="comment"># 将获取到的数据以字典的形式传递给 HTMl 文件</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'topics.html'</span>,&#123;<span class="string">'board'</span>:board&#125;)</span><br></pre></td></tr></table></figure>
<p>配置好路由和 View 之后，我们来配置下 HTML 文件,在 Teamplate 下新建文件 topics.html</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">templates/topics.html</span><br><span class="line"></span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;&#123;&#123; board.name &#125;&#125;&lt;/title&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"&#123;% static 'css/bootstrap.min.css' %&#125;"</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div class="container"&gt;</span><br><span class="line">        &lt;ol class="breadcrumb my-4"&gt;</span><br><span class="line">            &lt;li class="breadcrumb-item"&gt;Boards&lt;/li&gt;</span><br><span class="line">            &lt;li class="breadcrumb-item active"&gt;&#123;&#123; board.name &#125;&#125;&lt;/</span><br><span class="line">        li&gt;</span><br><span class="line">        &lt;/ol&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>输入网址 ：<code>http://127.0.0.1:8000/boards/3/</code> 即可访问到下面的页面</p>
<p><img src="2.png" alt></p>
<p>原理如下图，当我们在浏览器输入访问链接的时候，会通过 路由配匹配 View 函数，然后通过函数传递参数到 HTML 页面</p>
<p><img src="3.png" alt></p>
<h2 id="路由跳转"><a href="#路由跳转" class="headerlink" title="路由跳转"></a>路由跳转</h2><p>但是我们的最终目的是可以通过点击不同的主题，跳转到不同的页面。首先我们需要修改首页的 HTML 页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">templates/home.html</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'board_topics2' board.pk %&#125;"</span>&gt;</span>&#123;&#123; board.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">myproject/urls.py</span><br><span class="line">path('boards/<span class="tag">&lt;<span class="name">int:pk</span>&gt;</span>/',views.board_topics,name='board_topics'),</span><br></pre></td></tr></table></figure>
<p>将 <code>board.name</code> 通过 a 标签包裹起来，a 标签内的 href 的内容即通过填充的方法来实现，绑定我们在路由文件中路由链接的 name,我们可以很清晰的看到 myproject/urls.py 需要我们传入一个 pk 值，所以我们在 a 标签中将该主题的 pk 值写在后面。当我们点击该 a 标签时会发生如下操作拼接成合适的 URL。</p>
<ol>
<li>调用 myproject/urls.py 的 <code>path(&#39;boards/&lt;int:pk&gt;/&#39;,views.board_topics,name=&#39;board_topics&#39;)</code> 路由函数，将 board.pk 值传入链接中，拼接成 <code>http://127.0.0.1:8000/boards/1/</code> </li>
<li>通过 URL 触发绑定的 view 函数</li>
<li>将从数据库请求到的数据渲染到 HTML 文件上，最后反馈到浏览器</li>
</ol>
<h2 id="get-object-or-404"><a href="#get-object-or-404" class="headerlink" title="get_object_or_404"></a>get_object_or_404</h2><p>get_object_or_404 是 django shortcuts 模块里面一个比较简便的方法，主要体现在 django get 操作数据库的时候，可以帮助我们少写一些代码，加快开发速度。</p>
<p>当我们输入的网址是一个错误链接，如果我们在数据库中只有三条信息，但是我们在浏览器输入了 <code>http://127.0.0.1:8000/boards/4/</code> 查询对象不存在的话会抛出一个 DoesNotExist 的异常</p>
<p><img src="4.png" alt></p>
<p>为了更好的用户体验，我们在 view 函数中调用 get_object_or_404 方法，一般需要2个参数</p>
<ul>
<li>modelname 即我们需要查询数据库的表名</li>
<li>*args 要查询的条件是什么</li>
</ul>
<p>修改如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def board_topics(request,pk):</span><br><span class="line">    # 调用 get_object_or_404 方法</span><br><span class="line">    board = get_object_or_404(Board,pk=pk)</span><br><span class="line">    return render(request, &apos;topics.html&apos;, &#123;&apos;board&apos;: board&#125;)</span><br></pre></td></tr></table></figure></p>
<p>可以对比下上面的报错和下面的提醒</p>
<p><img src="5.png" alt></p>
<h1 id="模板复用"><a href="#模板复用" class="headerlink" title="模板复用"></a>模板复用</h1><p>到目前为止，我们一直在复制和粘贴 HTML 文档，长远来说是不可行的。接下来我们将重写 HTML 模板，创建一个 master page，其他模板添加它所独特的部分。</p>
<p>在 templates 文件夹中创建一个名为 base.html 的文件<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">templates/base.html</span><br><span class="line"></span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">        &lt;title&gt;&#123;% block title %&#125;Django Boards&#123;% endblock %&#125;&lt;/title&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"&#123;% static 'css/bootstrap.min.css' %&#125;"</span>&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div class="container"&gt;</span><br><span class="line">        &lt;ol class="breadcrumb my-4"&gt;</span><br><span class="line">            &#123;% block breadcrumb %&#125;</span><br><span class="line">            &#123;% endblock %&#125;</span><br><span class="line">        &lt;/ol&gt;</span><br><span class="line">            &#123;% block content %&#125;</span><br><span class="line">            &#123;% endblock %&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>这是我们的母版页。每个我们创建的模板都 extend 这个特殊的模板。现在我们介绍 <code>{% black %}</code><br>标签。它用于在模板中保留一个空间，一个 <code>子</code> 模板可以在这个空间内插入代码和 HTML。</p>
<p>在 <code>{% black title %}</code>中我们还设置了一个默认值 Django Boards ，如果我们在子模板中未设置 <code>{% black title %}</code> 的值它就会被使用。现在我们重写之前的两个模板。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- templates/home.html --&gt;</span><br><span class="line"></span><br><span class="line">&#123;% extends <span class="string">'base.html'</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">    &lt;li class="breadcrumb-item active"&gt;Boards&lt;/li&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">&lt;table class="table"&gt;</span><br><span class="line">    &lt;thead class="thead-inverse"&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;Board&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;Posts&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;Topics&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;Last Post&lt;/th&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &lt;/thead&gt;</span><br><span class="line">    &lt;tbody&gt;</span><br><span class="line">    &#123;% <span class="keyword">for</span> board <span class="keyword">in</span> boards %&#125;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;a href="&#123;% url 'board_topics2' board.pk %&#125;"&gt;&#123;&#123; board.name &#125;&#125;&lt;/a&gt;</span><br><span class="line">                &lt;small class="text-muted d-block"&gt;&#123;&#123; board.description &#125;&#125;&lt;/small&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td class="align-middle"&gt;0&lt;/td&gt;</span><br><span class="line">            &lt;td class="align-middle"&gt;0&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    &lt;/tbody&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- templates/topics.html --&gt;</span><br><span class="line"></span><br><span class="line">&#123;% extends &apos;base.html&apos; %&#125;</span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    &#123;&#123; board.name &#125;&#125; - &#123;&#123; block.super &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">    &lt;li class=&quot;breadcrumb-item&quot;&gt;Boards&lt;/li&gt;</span><br><span class="line">    &lt;li class=&quot;breadcrumb-item active&quot;&gt;&#123;&#123; board.name &#125;&#125;&lt;/li&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>唯一需要注意的点就是 <code>{{ block.super }}</code> 的使用，这是将继承来的文件的标题在这里再次使用。更新完这两部分的代码之后，我们运行项目会发现没有任何的变化。</p>
<p>接下来我们要为所有的页面都添加上一个菜单块</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- templates/base.html --&gt;</span><br><span class="line">&lt;nav class="navbar navbar-expand-lg navbar-dark bg-dark"&gt;</span><br><span class="line">    &lt;div class="container"&gt;</span><br><span class="line">        &lt;a class="navbar-brand" href="&#123;% url 'home' %&#125;"&gt;Django Boards&lt;/a&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/nav&gt;</span><br></pre></td></tr></table></figure>
<p><img src="6.png" alt><br><img src="7.png" alt></p>
<h1 id="Forms"><a href="#Forms" class="headerlink" title="Forms"></a>Forms</h1><p>Forms 用来处理我们的输入。这在任何 Web 应用或者网站中都是很常见的任务。标准的做法是通过 HTML 表单实现，用户输入一些数据，将其提交给服务器，然后服务器处理它。</p>
<p>表单处理是一项非常复杂的任务，因为它涉及到与应用多个层面的交互。有很多需要关心的问题。例如，提交给服务器的所有数据都是字符串的形式，所以在我们使用它之前需要将其转换为需要的数据类型（整型、浮点型，日期等）。我们必须验证有关应用程序业务逻辑的数据。我们还需妥善地清理和审查数据，以避免一些诸如 SQL 注入和 XSS 攻击等安全问题。</p>
<p>好消息是 Django Forms API 使得整个过程变得更加简单，从而实现了大量工作的自动化。而且，最终的结果比大多数程序员自己去实现的代码更加安全。所以不管 HTML 的表单多么简单，总是使用 Form API。</p>
<h2 id="自己实现表单"><a href="#自己实现表单" class="headerlink" title="自己实现表单"></a>自己实现表单</h2><p>为了能够更好的掌握表单的内容，虽然我们会使用 Form API ，但是我觉得学习下如何构建 Form 也是不错的事情。<br>很多问题诸如：该表单要处理两个不同的模型数据：Topic 和 POST ，我们应该只为登录认证过的用户去显示这个页面。这些问题，我们后续都会进行处理</p>
<p>首先，先创建一个新的 URL 路由，命名为 new_topic</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">myproject/urls.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,re_path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 boards APP 中导入 views</span></span><br><span class="line"><span class="keyword">from</span> boards <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'admin/'</span>, admin.site.urls),</span><br><span class="line">    <span class="comment"># 调用views.home</span></span><br><span class="line">    path(<span class="string">''</span>,views.home,name=<span class="string">'home'</span>),</span><br><span class="line">    <span class="comment"># 分页 为了适配之前的 url 路由适配方法 所以才用 re_path</span></span><br><span class="line">    <span class="comment"># re_path('boards/(?P&lt;pk&gt;\d+)/$',views.board_topics,name='board_topics'),</span></span><br><span class="line">    <span class="comment"># 修改为当前主流的 path 适配方法</span></span><br><span class="line">    path(<span class="string">'boards/&lt;int:pk&gt;/'</span>,views.board_topics_2,name=<span class="string">'board_topics2'</span>),</span><br><span class="line">+   path(<span class="string">'boards/&lt;int:pk&gt;/new/'</span>,views.new_topic,name=<span class="string">'new_topic'</span>),</span><br><span class="line">    path(<span class="string">'jsrender'</span>,views.jsrender,name=<span class="string">'jsrender'</span>), <span class="comment"># jsrender 传递参数</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>需要写一个相对于的 View 来匹配路由，注意路由已经传进来了 pk 值，这就相当于告诉了我们是哪个 boards 。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">boards/views.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,get_object_or_404</span><br><span class="line"><span class="comment"># 导入 HttpResponse 对象 由 DJango 自动创建</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse,JsonResponse</span><br><span class="line"><span class="comment"># 导入时间模块</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="comment"># 导入 Board 为数据调用做准备</span></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Board</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"><span class="comment"># 首页的视图函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">(request)</span>:</span></span><br><span class="line">    boards = Board.objects.all()<span class="comment"># 从数据库中读取 board 表内的数据</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'home.html'</span>,&#123;<span class="string">'boards'</span>:boards&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># render 传递参数至 js,HTML 调用 js 函数展示</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jsrender</span><span class="params">(request)</span>:</span></span><br><span class="line">    list = [<span class="string">'HTML'</span>,<span class="string">'Python'</span>, <span class="string">'Json'</span>, <span class="string">'JS'</span>]</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'jsRender.html'</span>, &#123;</span><br><span class="line">        <span class="string">'List'</span>: json.dumps(list),</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># re 匹配方法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">board_topics</span><span class="params">(request,pk)</span>:</span></span><br><span class="line">    <span class="comment">#pk 表示主键的意思</span></span><br><span class="line">    board = Board.objects.get(pk=pk)</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'topics.html'</span>,&#123;<span class="string">'board'</span>:board&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 适配 django2.2 的路由 path 匹配算法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">board_topics_2</span><span class="params">(request,pk)</span>:</span></span><br><span class="line">    board = get_object_or_404(Board,pk=pk)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'topics.html'</span>, &#123;<span class="string">'board'</span>: board&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  新建 topic 的</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_topic</span><span class="params">(request,pk)</span>:</span></span><br><span class="line">    board = get_object_or_404(Board,pk=pk)</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'new_topic.html'</span>,&#123;<span class="string">'board'</span>:board&#125;)</span><br></pre></td></tr></table></figure>
<p>然后我们需要将表单的模板写出来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">templates/new_topic.html</span><br><span class="line"></span><br><span class="line">&#123;% extends &apos;base.html&apos; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    Start a New Topic</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">    &lt;li class=&quot;breadcrumb-item&quot;&gt;&lt;a href=&quot;&#123;% url &apos;home&apos; %&#125;&quot;&gt;Boards&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;li class=&quot;breadcrumb-item&quot;&gt;&lt;a href=&quot;&#123;% url &apos;board_topics2&apos; board.pk %&#125;&quot;&gt;&#123;&#123; board.name &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;li class=&quot;breadcrumb-item active&quot;&gt;New topic&lt;/li&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们在浏览器输入下链接 访问下页面</p>
<p><img src="8.png" alt></p>
<p>接下来我们就需要将 HTML 页面中创建表单了<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">templates/new_topic.html</span><br><span class="line"></span><br><span class="line">&#123;% extends <span class="string">'base.html'</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    Start a New Topic</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">    &lt;li class="breadcrumb-item"&gt;&lt;a href="&#123;% url 'home' %&#125;"&gt;Boards&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;li class="breadcrumb-item"&gt;&lt;a href="&#123;% url 'board_topics2' board.pk %&#125;"&gt;&#123;&#123; board.name &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;li class="breadcrumb-item active"&gt;New topic&lt;/li&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;form method=<span class="string">"post"</span>&gt;</span><br><span class="line">        &#123;% csrf_token %&#125;</span><br><span class="line">        &lt;div class="form-group"&gt;</span><br><span class="line">            &lt;label for="id_subject"&gt;Subject&lt;/label&gt;</span><br><span class="line">            &lt;input type="text" class="form-control" id="id_subject" name="subject"&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div class="form-group"&gt;</span><br><span class="line">            &lt;label for="id_message"&gt;Message&lt;/label&gt;</span><br><span class="line">            &lt;textarea class="form-control" id="id_message" name="message" row="10"&gt;&lt;/textarea&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;button type="submit" class="btn btn-success"&gt;Post&lt;/button&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="9.png" alt></p>
<p>在 <code>&lt;form&gt;</code> 标签中，我们定义了 method 属性。它会告诉浏览器我们想如何与服务器通信。HTTP 规范定义了几种 request methods （请求方法）。但是在大部分情况下，我们只需要使用 GET 和 POST 两种 request 类型。</p>
<p><strong>Get</strong> 可能是最常见的请求类型了。它用于从服务器请求数据。每当你点击了一个链接或者直接在浏览器中输入了一个网址时，你就创建了一个 <strong>GET</strong> 请求。</p>
<p><strong>POST</strong> 用于当我们想更改服务器上的数据的时候。一般来说，每次我们发送数据给服务器都会导致资源状态的变化，我们应该是要 <strong>POST</strong> 请求发送数据。</p>
<p>Django 使用 <strong>CSRF token(Cross-site Request Forgery Token)</strong> 保护所有的 <strong>POST</strong> 请求。这是一个避免外部站点或者应用程序向我们的应用程序提交数据的安全措施。应用程序每次接受一个 <strong>POST</strong>  时，都会先检查 <strong>CSRF Token</strong>。如果这个 request 没有 token ，或者这个 token 是无效的，他就会抛弃提交的数据。</p>
<p><strong>CSRF Token</strong> 的模板标签 <code>{% csrf_token %}</code> 它是与其他表单数据一起提交的隐藏字段。</p>
<h3 id="服务器如何获取数据"><a href="#服务器如何获取数据" class="headerlink" title="服务器如何获取数据"></a>服务器如何获取数据</h3><p>我们需要设置 HTML 输入的 name, name 被用来在服务器获取数据。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">templates/new_topic.html</span><br><span class="line"></span><br><span class="line">&lt;input type="text" class="form-control" id="id_subject" name="subject"&gt;</span><br><span class="line">&lt;textarea class="form-control" id="id_message" name="message" row="10"&gt;&lt;/textarea&gt;</span><br></pre></td></tr></table></figure>
<p>我们如何检索数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subject = request.POST[<span class="string">'subject'</span>]</span><br><span class="line">message = request.POST[<span class="string">'message'</span>]</span><br></pre></td></tr></table></figure>
<p>所以，从 HTML 获取数据并且开始一个新的 topic 视图的简单实现可以这样写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">boards/views.py</span><br><span class="line"></span><br><span class="line">def new_topic(request,pk):</span><br><span class="line">    board = get_object_or_404(Board,pk=pk)</span><br><span class="line"></span><br><span class="line">    if request.method ==&apos;POST&apos;:</span><br><span class="line">        subject = request.POST[&apos;subject&apos;]</span><br><span class="line">        message = request.POST[&apos;message&apos;]</span><br><span class="line"></span><br><span class="line">        user = User.objects.first() # 临时使用一个账号作为登录用户 </span><br><span class="line">        </span><br><span class="line">        # 将获取的数据写入数据库 topic 表</span><br><span class="line">        topic = Topic.objects.create(</span><br><span class="line">            # 前端传来的数据</span><br><span class="line">            subject = subject,</span><br><span class="line">            # 存的是 board_id</span><br><span class="line">            board = board,</span><br><span class="line">            # 存的是 starter_id</span><br><span class="line">            starter= user</span><br><span class="line">        )</span><br><span class="line">        # 将获取的数据写入数据库的 post 表</span><br><span class="line">        post = Post.objects.create(</span><br><span class="line">            # 文本</span><br><span class="line">            message = message,</span><br><span class="line">            # topic_id</span><br><span class="line">            topic = topic,</span><br><span class="line">            # user_id</span><br><span class="line">            created_by=user</span><br><span class="line">        )</span><br><span class="line">        # 重定向到 http://127.0.0.1:8000/boards/1/</span><br><span class="line">        return redirect(&apos;board_topics2&apos;,pk=board.pk)</span><br><span class="line">    return render(request,&apos;new_topic.html&apos;,&#123;&apos;board&apos;:board&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="10.png" alt></p>
<p>在 <code>board = board</code> 这行，我们设置了 <code>Topic</code> 模型中的 <code>board</code> 字段，它是 <code>ForeignKey(Board)</code> 。 因此，我们的 <code>Board</code> 实例就知道了与它关联的 Topic 实例，在 <code>templates/topics.html</code> 中我们使用 <code>board.topics.all</code> 而不是 <code>board.topics</code>，是因为 <code>board.topics</code> 是一个 <strong>Related Manager</strong>，它与 <code>Model Manager</code> 很相似，通常在 <code>board.objects</code> 可得到。所以要返回给定的 <code>baord</code> 的所有 <code>Topic</code> 我们必须使用 <code>board.topics.all()</code>，要过滤一些数据，我们可以这样用 <code>board.topics.filter(subject__contains =&#39;Hello&#39;)</code>。</p>
<p>这样子就将用户 、 topic 、 post 绑定绑定起来了。这里面，路由起了串联匹配的作用。将 MTV 的模型全部都连接了起来，在数据库的效果如下</p>
<p><img src="11.png" alt><br><img src="12.png" alt><br><img src="13.png" alt></p>
<p>这个视图函数只考虑能接受数据并且保存到数据库的乐观合法的 path，但是还缺少一些数据。我们没有验证数据。用户可以提交空表单或者提交长于 266 个字符的 subject.</p>
<p>到目前为止，我们都在对 User 字段进行硬编码，因为我们还没有实现身份验证。此外，我们还没有实现列出 topic 的所有 posts 的视图，实现了它，我们就可以将用户重定向到列出所有主题的列表页面。</p>
<h3 id="跨表查询"><a href="#跨表查询" class="headerlink" title="跨表查询"></a>跨表查询</h3><p>看起来成功了。但是我们还没有实现主题的列表页面，所以没有东西可看，让我们编辑下 <code>templates/topics.htm</code> 来实现一个合适的列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">templates/topics.html</span><br><span class="line"></span><br><span class="line">&#123;% extends <span class="string">'base.html'</span> %&#125;</span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    &#123;&#123; board.name &#125;&#125; - &#123;&#123; block.super &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">    &lt;li class="breadcrumb-item"&gt;&lt;a href="&#123;% url 'home' %&#125;"&gt;Boards&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;li class="breadcrumb-item active"&gt;&#123;&#123; board.name &#125;&#125;&lt;/li&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;table class="table"&gt;</span><br><span class="line">        &lt;thead class="thead-inverse"&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;th&gt;Topic&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;Starter&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;Replies&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;Views&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;Last Update&lt;/th&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">            &#123;% <span class="keyword">for</span> topic <span class="keyword">in</span> board.topics.all %&#125;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td&gt;&#123;&#123; topic.subject &#125;&#125;&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;&#123;&#123; topic.starter.username &#125;&#125;&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;0&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;0&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;&#123;&#123; topic.last_updated &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>在 View 中传给 Topic 的数据模型是 <code>Board</code>，所以我们如果要查询 Topic 的数据的话只能通过 <code>board.topics.all</code> 来实现 。</p>
<p>但是如果我们要查询 Post 的数据就不能实现了，因为我们的 Model 设计的时候并没有将两者串联起来，而传过来的数据并不是 Topic ，否则我们可以使用 topic.post.all 的方法进行读取 Post 的数据。</p>
<p>需要注意的是，我们在 <code>templates/topics.html</code> 文件中使用的是 <code>board.topics.all</code> ，这种语法是可以实现跨表查询。但是我们在 Python 代码中，是必须使用括号的 <code>board.topics.all()</code></p>
<p><img src="14.png" alt></p>
<blockquote>
<p>我们创建的 Topic 显示在这上面了。这里有两个新概念，我们首次使用 <strong>Board</strong> 模型中的 topics 属性。 <code>Topic</code> 属性由 <code>django</code> 使用方向方向关系自动创建。在之前的步骤中，我们创建了一个 <code>Topic</code> 实例，这段话非常重要！</p>
</blockquote>
<h3 id="外键"><a href="#外键" class="headerlink" title="外键"></a>外键</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; topic.starter.username &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>使用一个点加上属性这种写法，我们几乎可以访问 <strong>User</strong> 模型的所有属性。如果我们想得到用户的 email，我们可以使用 topic.starter.email。</p>
<h3 id="路由跳转-New-Topic"><a href="#路由跳转-New-Topic" class="headerlink" title="路由跳转 New Topic"></a>路由跳转 New Topic</h3><p>虽然我们已经有了添加 Topic 的页面和完善了 Topic 的展示页面，但是并没有将两者之间的跳转联系起来。在 View 函数中我们已经写好了重定向的功能，新建了 Topic 之后会跳转回 Topic 的页面，但是在 Topic 缺少一个跳转到 New Topic 的按钮。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">templates/topics.html</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;div class="mb-4"&gt;</span><br><span class="line">        &lt;a href="&#123;% url 'new_topic' board.pk %&#125;" class="btn btn-primary"&gt;New topic&lt;/a&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;table class="table"&gt;</span><br><span class="line">        &lt;!-- code suppressed for brevity --&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p><img src="15.png" alt></p>
<h2 id="使用-Forms-创建表单"><a href="#使用-Forms-创建表单" class="headerlink" title="使用 Forms 创建表单"></a>使用 Forms 创建表单</h2><p>自从我们开始使用 Forms ，我们走了很长一段路。但是，最终目的是为了使用 Forms API。 </p>
<p>Forms API 可在模板 <code>django.forms</code> 中得到。 Django 使用两种类型的 form ：<code>forms.Form</code> 和 <code>forms.ModelForm</code>。 <code>Form</code> 类是通用的表单实现。我们可以使用它来处理与应用程序 model 没有直接关联的数据。</p>
<p>在 <code>boards</code> 文件夹下创建一个新的文件 <code>forms.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">boards/forms.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Topic</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewTopicForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    message = forms.CharField(widget=forms.Textarea(),max_length=<span class="number">4000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Topic</span><br><span class="line">        fields =[<span class="string">'subject'</span>,<span class="string">'message'</span>]</span><br></pre></td></tr></table></figure>
<p>这是我们的第一个 form。它是一个与 Topic model 相关联的 <code>ModelForm</code> 。 Meta 类里面 fields 列表中的 subject 引用 Topic 类中 subject field(字段)。现在注意到我们定义了一个叫做 message 的额外字段。它用来引用 Post 中我们想要保存的 message 。</p>
<p>现在我们需要重写我们的 views.py </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">boards/views.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># 引入我们创建的表单</span></span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> NewTopicForm</span><br><span class="line"><span class="comment"># 新建 topic 的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_topic</span><span class="params">(request,pk)</span>:</span></span><br><span class="line">    board = get_object_or_404(Board,pk=pk)</span><br><span class="line">    user = User.objects.first()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">'POST'</span>:</span><br><span class="line">        <span class="comment"># 如果是 POST 请求 则将请求传入表单</span></span><br><span class="line">        form = NewTopicForm(request.POST)</span><br><span class="line">        <span class="comment"># 如果表单的请求是有效的 则使用 form.save() 存入数据库</span></span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            <span class="comment"># save方法返回的一个存入数据库的 Model 实例</span></span><br><span class="line">            <span class="comment"># 因为这是一个 Topic form 所以会创建一个 Topic</span></span><br><span class="line">            topic = form.save(commit=<span class="literal">False</span>)</span><br><span class="line">            topic.board=board</span><br><span class="line">            topic.starter = user</span><br><span class="line">            topic.save()</span><br><span class="line"></span><br><span class="line">            post = Post.objects.create(</span><br><span class="line">                message = form.cleaned_data.get(<span class="string">'message'</span>),</span><br><span class="line">                topic = topic,</span><br><span class="line">                created_by=user</span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># 重定向</span></span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'board_topics2'</span>,pk=board.pk)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = NewTopicForm()</span><br><span class="line">    <span class="comment"># 如果数据是无效的 ，django 会给 form 添加错误列表</span></span><br><span class="line">    <span class="comment"># 然后 视图函数不会做任何处理并且原本的表单页面 并显示错误</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'new_topic.html'</span>,&#123;<span class="string">'board'</span>:board,<span class="string">'form'</span>:form&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">templates/new_topic.html</span><br><span class="line"></span><br><span class="line">&#123;% extends <span class="string">'base.html'</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">    Start a New Topic</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">    &lt;li class="breadcrumb-item"&gt;&lt;a href="&#123;% url 'home' %&#125;"&gt;Boards&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;li class="breadcrumb-item"&gt;&lt;a href="&#123;% url 'board_topics2' board.pk %&#125;"&gt;&#123;&#123; board.name &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;li class="breadcrumb-item active"&gt;New topic&lt;/li&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;form method=<span class="string">"post"</span>&gt;</span><br><span class="line">        &#123;% csrf_token %&#125;</span><br><span class="line">        &#123;&#123; form.as_p &#125;&#125;</span><br><span class="line">        &lt;button type="submit" class="btn btn-success"&gt;Post&lt;/button&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>这个 form 有三个渲染选项： form.as_table，form.as_url 和 form.as_p 。这是一个快速的渲染表单所有字段的方法。顾名思义，as_table 使用 table 标签来做格式化输入，as_ul 使用标签。</p>
<p><img src="16.png" alt></p>
<p>我们以前的 form 看起来更好，是吧？我们将立即修复它。</p>
<p>它看起来很破，但是相信我；它背后有很多东西。它非常强大，如果我们的表单有50个字段，我们可以通过键入  来显示所有字段。 此外，使用 Forms API，Django 会验证数据并且向每个字段添加错误信息。</p>
<p>它还可以处理在 Form 类或者 Model 类中定义的帮助文本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">boards/forms.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Topic</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewTopicForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    message = forms.CharField(</span><br><span class="line">        widget=forms.Textarea(</span><br><span class="line">            attrs=&#123;<span class="string">'rows'</span>:<span class="number">5</span>,<span class="string">'placeholder'</span>:<span class="string">'what is on your mind?'</span>&#125;</span><br><span class="line">            <span class="comment"># 输入框内的文本</span></span><br><span class="line">        ),max_length=<span class="number">4000</span>,</span><br><span class="line">        help_text=<span class="string">'The max length of the text is 4000.'</span></span><br><span class="line">        <span class="comment"># 提示文本</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Topic</span><br><span class="line">        fields =[<span class="string">'subject'</span>,<span class="string">'message'</span>]</span><br></pre></td></tr></table></figure>
<p><img src="17.png" alt></p>
<h3 id="美化表单"><a href="#美化表单" class="headerlink" title="美化表单"></a>美化表单</h3><p>当使用 BootStrap 或者其他的前端库时，我比较喜欢使用一个叫做 django-widget-tweak 的 Django库。这一部分的详细讲解略去，大家看一看原文章.<br>简单操作主要有3步</p>
<ul>
<li>装一个第三方库 <code>python manage.py createsuperuser</code></li>
<li>在 APP 配置中添加 <code>widget_tweaks</code></li>
<li>修改 HTML 表单模板</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &apos;base.html&apos; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% load widget_tweaks %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Start a New Topic&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block breadcrumb %&#125;</span><br><span class="line">    &lt;li class=&quot;breadcrumb-item&quot;&gt;&lt;a href=&quot;&#123;% url &apos;home&apos; %&#125;&quot;&gt;Boards&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;li class=&quot;breadcrumb-item&quot;&gt;&lt;a href=&quot;&#123;% url &apos;board_topics&apos;</span><br><span class="line">    board.pk %&#125;&quot;&gt;&#123;&#123; board.name &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;li class=&quot;breadcrumb-item active&quot;&gt;New topic&lt;/li&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;form method=&quot;post&quot; novalidate&gt;</span><br><span class="line">        &#123;% csrf_token %&#125;</span><br><span class="line"></span><br><span class="line">        &#123;% for field in form %&#125;</span><br><span class="line">            &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">            &#123;&#123; field.label_tag &#125;&#125;</span><br><span class="line"></span><br><span class="line">            &#123;% render_field field class=&quot;form-control&quot; %&#125;</span><br><span class="line"></span><br><span class="line">            &#123;% if field.help_text %&#125;</span><br><span class="line">                &lt;small class=&quot;form-text text-muted&quot;&gt;</span><br><span class="line">                &#123;&#123; field.help_text &#125;&#125;</span><br><span class="line">                &lt;/small&gt;</span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">        &lt;button type=&quot;submit&quot; class=&quot;btn btn-success&quot;&gt;Post&lt;/button&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h1><ul>
<li><strong>URLs</strong> 存在 urls 转 path 的难点，但是页面跳转的过程再一次在开发过程中变得更清晰。URL 复用和 view 的配合使得我们开发多个相同结构、不同内容页面的展示变得更加轻松。</li>
<li><strong>模板复用</strong> 在将下来的项目中，我甚至只需要写一个基础页面，然后继承，通过不同的 URLs 来查询不同的数据库数据并进行展示即可，这个功能非常的好。我改动主题也只需要改动一处即可。</li>
<li>表单</li>
</ul>
<p><strong>难点</strong> 路由配置、表单处理和跨表查询</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://www.cnblogs.com/jinyudong/p/8479916.html" target="_blank" rel="noopener">在 Django 中建个 Form 表单</a></li>
<li><a href="https://www.cnblogs.com/jjzz1234/p/11607793.html" target="_blank" rel="noopener">Django-ORM 之 ForeignKey 的多对一关系</a></li>
</ul>

      </div>
      
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/Django/">Django</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2020/03/25/15-A Complete Beginner`s Guide to Django -- User module/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">A Complete Beginner`s Guide to Django -- User module</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    <a class="next" href="/2020/03/24/13-Django - render Or HttpResponse/">
        <span class="next-text nav-default">Django - render Or HttpResponse Or redirect</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:afrunk7@gmail.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/afrunk" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2019 - 2021<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Afrunk</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
