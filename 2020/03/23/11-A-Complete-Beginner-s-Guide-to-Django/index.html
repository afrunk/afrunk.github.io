<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="A Complete Beginner`s Guide to Django -- Models Fundamentals"><meta name="keywords" content="Django, afrunk"><link rel="alternate" href="/default" title="afrunk"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="http://afrunk.github.io/2020/03/23/11-A-Complete-Beginner-s-Guide-to-Django/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css"><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":true};
</script>

    <title>A Complete Beginner`s Guide to Django -- Models Fundamentals - afrunk</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">afrunk</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archivew
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/MachineLearning/">
        <li class="mobile-menu-item">机器学习
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">afrunk</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archivew
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/MachineLearning/">
            机器学习
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">A Complete Beginner`s Guide to Django -- Models Fundamentals
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-03-23
        </span><span class="post-category">
            <a href="/categories/Django-Tutorial/">Django Tutorial</a>
            </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#System-design"><span class="toc-text">System design</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Class-Diagram-类图"><span class="toc-text">Class Diagram 类图</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Wirdframes-原型图"><span class="toc-text">Wirdframes 原型图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#New-Topic"><span class="toc-text">New Topic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reply"><span class="toc-text">Reply</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Models"><span class="toc-text">Models</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Django-Settings"><span class="toc-text">Django Settings</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django-Models"><span class="toc-text">Django Models</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ForeignKey"><span class="toc-text">ForeignKey</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Models-API"><span class="toc-text">Models API</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusions"><span class="toc-text">Conclusions</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li></ol>
    </div>
  </div><div class="post-content"><p>上一节，我们写了一个简单的 Django Project，现在我们要进一步的了解它里面涉及的知识点都有哪些。在学习之前我们先讨论一些项目的背景知识，并由此引入如何使用 Models、Views、Templates、Testing and Admin。</p>
<p>这是第一篇，详细讲述 Models 模块。<br><a id="more"></a></p>
<h1 id="System-design"><a href="#System-design" class="headerlink" title="System design"></a>System design</h1><p>首先介绍下我们的项目——论坛系统，整个项目的构思是维护几个论坛模块（boards)，每个版块像一个分类一样。在指定的版块里面，用户可以通过创建新主题（Topic)开始讨论，其他用户参与讨论回复。</p>
<p>我们需要找到一种方法来区分普通用户和管理员用户，因为只有管理员可以创建版块。下图描述了主要的用例和每种类型的用户角色：<br><img src="1.png" alt></p>
<p>从上图，我们可以开始思考项目所需的实体类有哪些。这些实体就是我们要创建的模型，它与我们的 Django 应用程序处理的数据非常密切。</p>
<p>为了实现上面的用例，我们需要至少实现下面几个模型</p>
<p><img src="2.png" alt></p>
<ul>
<li>Board 版块</li>
<li>Topic 主题</li>
<li>Post 帖子 主题的回复或评论</li>
</ul>
<p>模型之间如何相互关联也很重要。类与类之间的实线告诉我们，在一个 Topic 中，我们需要有一个字段来确定它属于哪个 Board。同样，Post 也需要一个字段来表示它属于哪个主题，这样我们就可以列出在特定主题内创建的 Post。最后，我们需要一个字段来表示主题是谁发起的，帖子是谁发的。</p>
<h2 id="Class-Diagram-类图"><a href="#Class-Diagram-类图" class="headerlink" title="Class Diagram 类图"></a>Class Diagram 类图</h2><p>用户和版块之间也有联系，谁创建的版块。但是这些信息与应用程序无关。还有其他方法可以跟踪这些信息，下图就是模型之间的关系图</p>
<p><img src="3.png" alt></p>
<p>这个类图强调的是模型之间的关系，这些线条和箭头最终会在稍后转换为字段。</p>
<p>对于 Board 模型，我们将从两个字段开始：name 和 description。 name字段必须是唯⼀的，为了避免有重复的名称。description ⽤于说明这个版块是做什么⽤的。</p>
<p>Topic 模型包括四个字段：subject 表示主题内容，last_update ⽤来定义话题的排序，starter ⽤来识别谁发起的话题，board ⽤于指定它属于哪个版块。</p>
<p>Post 模型有⼀个 message 字段，⽤于存储回复的内容，created_at 在排序时候⽤（最先发表的帖⼦排最前⾯），updated_at 告诉⽤户是否更新了内容，同时，还需要有对应的 User 模型的引⽤，Post 由谁创建的和谁更新的。</p>
<p>最后是 User 模型。在类图中，我只提到了字段 username，password，email， is_superuser 标志，因为这⼏乎是我们现在要使⽤的所有东⻄。需要注意的是，我们不需要创建 User模型，因为Django已经在contrib包中内置了User模型，我们将直接拿来⽤。</p>
<p>关于类图之间的对应关系是一个重点，下图有进行详细的描述</p>
<p><img src="4.png" alt></p>
<p>关系图虽然是已经很清晰的类图了，但是还有一种画类图的方法是强调字段而不是模型之间的关系</p>
<p><img src="5.png" alt></p>
<p>这种表示方法与前面的表示方式是对等的，不过这种方式更接近我们将要使用 Django Models API 设计的内容。在这种表示方式中，我们可以更清楚地看到，在 Post 模型中，关联了 Topic\created_by (创建者) 和 updated_by (更新者) 字段。另一个值得注意的事情是，在 Topic 模型中有一个名为 Posts() 的操作(一个类方法)。我们将通过反向关系来实现这一目标，Django 将自动在数据库中执行查询以返回特定主题的所有帖子列表。</p>
<h1 id="Wirdframes-原型图"><a href="#Wirdframes-原型图" class="headerlink" title="Wirdframes 原型图"></a>Wirdframes 原型图</h1><p>这一部分是作者希望通过画原型图的方式来更加清晰的了解需求</p>
<blockquote>
<p>After spending some time designing the application models, I like to create some wireframes to define what needs to be done and also to have a clear picture of where we are going.<br>Then based on the wireframes we can gain a deeper understanding of the entities involved in the application.</p>
</blockquote>
<p>首先，我们会有一个首页展示所有的模块<br><img src="6.png" alt></p>
<p>然后点击模块的按钮进入到某一个模块，会有两个功能</p>
<ul>
<li>创建一个新的帖子</li>
<li>点击铁子链接进行查看或参与讨论<br><img src="7.png" alt></li>
</ul>
<h2 id="New-Topic"><a href="#New-Topic" class="headerlink" title="New Topic"></a>New Topic</h2><p><img src="8.png" alt></p>
<h2 id="Reply"><a href="#Reply" class="headerlink" title="Reply"></a>Reply</h2><ul>
<li>查看之前的回复</li>
<li>回复该主题帖子<br><img src="9.png" alt><br><img src="10.png" alt></li>
</ul>
<h1 id="Models"><a href="#Models" class="headerlink" title="Models"></a>Models</h1><p>模型设计即应用程序的数据库设计（在Django中是可以这样子表述的）。本节我们要做的是创建 Django 所代表的类，这些类就是在上一节中建模的类：Board，Topic和Post。User 模型被命名为内置应用叫做 <strong>auth</strong>,它以命名空间 django.contrib.auth 的形式出现在 INSTALLED_APPS 配置中,所以我们并不需要进行额外的模型搭建。</p>
<h2 id="Django-Settings"><a href="#Django-Settings" class="headerlink" title="Django Settings"></a>Django Settings</h2><p>在构建 Models 之前，我们需要修改数据库的配置，将本项目和我们的 Mysql 数据库连接起来。这都是在 Project Name 文件夹下的 settings.py 文件中进行修改，同时我们也修改一些其他的配置内容。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">myproject/settings.py</span><br><span class="line"></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>, <span class="comment">#数据存储在mysql中</span></span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">"acbdg"</span>, <span class="comment"># 数据库名为 acbdg</span></span><br><span class="line">        <span class="string">'USER'</span>:<span class="string">"root"</span>, <span class="comment"># 账号</span></span><br><span class="line">        <span class="string">'PASSWORD'</span>:<span class="string">"password"</span>, <span class="comment"># 密码</span></span><br><span class="line">        <span class="string">'HOST'</span>:<span class="string">"127.0.0.1"</span> <span class="comment">#默认地址</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">LANGUAGE_CODE = <span class="string">'zh-hans'</span> <span class="comment"># 语言</span></span><br><span class="line"></span><br><span class="line">TIME_ZONE = <span class="string">'Asia/Shanghai'</span> <span class="comment"># 时区</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳转设置 无论从什么链接进入都会跳转到首页</span></span><br><span class="line">LOGOUT_REDIRECT_URL = <span class="string">'/'</span></span><br><span class="line">LOGIN_REDIRECT_URL = <span class="string">'/'</span></span><br></pre></td></tr></table></figure></p>
<p>配置好数据库之后，我们首先进行一个数据的同步，看数据库的配置是否合适。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(base) myproject&gt;python manage.py makemigrations</span><br><span class="line">(base) myproject&gt;python manage.py migrate</span><br></pre></td></tr></table></figure>
<p>我们就可以在 Mysql 数据库中看到内置的一些 Models 表<br><img src="11.png" alt></p>
<h2 id="Django-Models"><a href="#Django-Models" class="headerlink" title="Django Models"></a>Django Models</h2><p>以下是构建模型的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">boards/models.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="comment"># 我们不构建用户模型 直接继承 Django 内置模块</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">为什么每个类都需要继承 models.Model </span></span><br><span class="line"><span class="string">因为所有的模型都是 django.db.models.Field 子类 </span></span><br><span class="line"><span class="string">这样每个类都被转换为数据库内的表</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">每个字段由 django.db.models.Field子类的实例表示</span></span><br><span class="line"><span class="string">它们并将会被转换为数据库的列</span></span><br><span class="line"><span class="string">字段 CharField、DataTimeField等等</span></span><br><span class="line"><span class="string">都是 django.db.models.Filed的子类</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">有些字段需要参数 例如 CharField </span></span><br><span class="line"><span class="string">我们应该设定一个 max_length 这些信息将用于创建数据库列 </span></span><br><span class="line"><span class="string">Django 需要知道数据库列需要多大</span></span><br><span class="line"><span class="string">该 max_length 参数也将被 Django Forms API 用来验证用户输入</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">related_name 是可选项</span></span><br><span class="line"><span class="string">但是如果我们不为它设置一个名称</span></span><br><span class="line"><span class="string">Django会自动生成它：（class_name)_set</span></span><br><span class="line"><span class="string">如在 Board 模型中，所有的 Topic 列表将用 topic_set 属性表示</span></span><br><span class="line"><span class="string">如果设置 related_name ='+' </span></span><br><span class="line"><span class="string">指示 Django 我们不需要这种反向关系，所以它会被忽略</span></span><br><span class="line"><span class="string">也就是说我们不需要关系用户修改哪些帖子</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Board</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># unique= True 强调数据库级别字段的唯一性</span></span><br><span class="line">    <span class="comment"># 必须添加 default 否则会报错告诉你必须添加默认值</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">30</span>,unique=<span class="literal">True</span>,default=<span class="string">'test'</span>)</span><br><span class="line">    description = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 帖子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Topic</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    subject = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    last_updated = models.DateField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># Board 可以通过 related_name 参数用于创建反向关系</span></span><br><span class="line">    <span class="comment"># 访问属于该板块下的 Topic 列表</span></span><br><span class="line">    board =models.ForeignKey(Board,related_name=<span class="string">'topics'</span>,on_delete=models.CASCADE)</span><br><span class="line">    starter= models.ForeignKey(User,related_name=<span class="string">'topics'</span>,on_delete=models.CASCADE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回复</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    message = models.TextField(max_length=<span class="number">4000</span>)</span><br><span class="line">    <span class="comment">#模型之间创建一个链接，并在数据库级别创建适当的关系</span></span><br><span class="line">    <span class="comment"># 参数 related_name ,用于引用它关联的模型</span></span><br><span class="line">    <span class="comment"># 比如在 Topic 中可以使用 Topic.posts来查看这个帖子有哪些回复</span></span><br><span class="line">    topic = models.ForeignKey(Topic,on_delete=models.CASCADE)</span><br><span class="line">    <span class="comment"># auto_now_add 自动添加当前日期和时间</span></span><br><span class="line">    created_at = models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># null= True 表示空值也将会被存储</span></span><br><span class="line">    update_at = models.DateTimeField(null=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 在 User 中可以使用 User.posts 来查看这个用户有哪些回复</span></span><br><span class="line">    created_by = models.ForeignKey(User,related_name=<span class="string">'posts'</span>,on_delete=models.CASCADE)</span><br><span class="line">    <span class="comment"># 看注释理解 related_name = '+' 的用法</span></span><br><span class="line">    update_by = models.ForeignKey(User,null=<span class="literal">True</span>,on_delete=models.CASCADE)</span><br></pre></td></tr></table></figure>
<p>我们需要在外键的参数中添加上 on_delete ，否则会报错<code>topic = models.ForeignKey(Topic,related_name=&#39;posts&#39;) TypeError: __init__() missing 1 required positional argument: &#39;on_delete&#39;</code> 定义外键的时候需要加上 <code>on_delete = models.CASCADE</code></p>
<p>原因： Django 升级到了 2.0 之后，表与表之间关联的时候，必须要写 on_delete 参数，否则会报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">on_delete=None,               # 删除关联表中的数据时,当前表与其关联的field的行为</span><br><span class="line">on_delete=models.CASCADE,     # 删除关联数据,与之关联也删除</span><br><span class="line">on_delete=models.DO_NOTHING,  # 删除关联数据,什么也不做</span><br><span class="line">on_delete=models.PROTECT,     # 删除关联数据,引发错误ProtectedError</span><br><span class="line"># models.ForeignKey(&apos;关联表&apos;, on_delete=models.SET_NULL, blank=True, null=True)</span><br><span class="line">on_delete=models.SET_NULL,    # 删除关联数据,与之关联的值设置为null（前提FK字段需要设置为可空,一对一同理）</span><br><span class="line"># models.ForeignKey(&apos;关联表&apos;, on_delete=models.SET_DEFAULT, default=&apos;默认值&apos;)</span><br><span class="line">on_delete=models.SET_DEFAULT, # 删除关联数据,与之关联的值设置为默认值（前提FK字段需要设置默认值,一对一同理）</span><br><span class="line">on_delete=models.SET,         # 删除关联数据,</span><br><span class="line">a. 与之关联的值设置为指定值,设置：models.SET(值)</span><br><span class="line">b. 与之关联的值设置为可执行对象的返回值,设置：models.SET(可执行对象)</span><br></pre></td></tr></table></figure></p>
<p>由于 ManyToMantField 没有 on_delete 参数，所以以上只针对外键 ForeignKey 和 OneToOneField。</p>
<p><strong>具体的 Models 的写法我都在注释中标注了，如果对于外键还是有理解误差的话可以看下图</strong><br><img src="12.png" alt></p>
<p>再次运行上面的迁移模型的代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(base) myproject&gt;python manage.py makemigrations</span><br><span class="line">(base) myproject&gt;python manage.py migrate</span><br></pre></td></tr></table></figure></p>
<p>再次报错 <code>Please select a fix: 1) Provide a one-off default now (will be set on all existing rows with a null value for this column)2) Quit, and let me add a default in models.py</code>,报错的原因是因为我们之前已经使用了一次迁移模型，现在再进行该操作导致产生了冲突，<strong>将<code>boards/migrations/0001_initial.py</code> 删除掉在重新运行上述代码即可。</strong></p>
<h2 id="ForeignKey"><a href="#ForeignKey" class="headerlink" title="ForeignKey"></a>ForeignKey</h2><p>最后我们来看下三个表的内容都有哪些，注意看外键的键值<br><img src="13.png" alt><br><img src="14.png" alt><br><img src="15.png" alt></p>
<p>让我们在看看在代码中是如何引入的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">board =models.ForeignKey(Board,related_name=&apos;topics&apos;,on_delete=models.CASCADE)</span><br><span class="line">starter= models.ForeignKey(User,related_name=&apos;topics&apos;,on_delete=models.CASCADE)</span><br></pre></td></tr></table></figure></p>
<p>为什么到了数据库中，存储的键变成了 board_id 和 starter_id ? 无需惊讶，这就是它应该有的样子。</p>
<p><strong>那么 board 和 board_id 之间有什么关系呢？</strong> 在 Python Shell 中我们查询 Board 得到对象，包含 board_id 在内的外键对应的对象，在 Django 中创建外键时，默认是以目标的主键作为对应项。</p>
<h2 id="Models-API"><a href="#Models-API" class="headerlink" title="Models API"></a>Models API</h2><p>构建好了 Models 之后，我们可以使用 Python Shell 验证我们的 API 下面的代码涉及如下部分的内容</p>
<ul>
<li>往表内插入数据</li>
<li>更新表内数据</li>
<li>读取表内数据<ol>
<li>遍历 QuerySet 的所有数据</li>
<li>读取单个数据</li>
</ol>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>操作</th>
<th>代码示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>创建一个对象而不保存</td>
<td>board=Board()</td>
</tr>
<tr>
<td>保存一个对象（创建或更新）</td>
<td>board.save()</td>
</tr>
<tr>
<td>数据库中创建并保存一个对象</td>
<td>Board.objects.create(name=’’,description=’’)</td>
</tr>
<tr>
<td>列出所有对象</td>
<td>Board.object.all()</td>
</tr>
<tr>
<td>通过字段标识获取单个对象</td>
<td>Board.objects.all()</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入 Python Shell 版块</span></span><br><span class="line">(base) myproject&gt;python manage.py shell</span><br><span class="line">Python <span class="number">3.7</span><span class="number">.1</span> (default, Dec <span class="number">10</span> <span class="number">2018</span>, <span class="number">22</span>:<span class="number">54</span>:<span class="number">23</span>) [MSC v<span class="number">.1915</span> <span class="number">64</span> bit (AMD64)]</span><br><span class="line">Type <span class="string">'copyright'</span>, <span class="string">'credits'</span> <span class="keyword">or</span> <span class="string">'license'</span> <span class="keyword">for</span> more information</span><br><span class="line">IPython <span class="number">7.2</span><span class="number">.0</span> -- An enhanced Interactive Python. Type <span class="string">'?'</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入 Board 类 </span></span><br><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> boards.models <span class="keyword">import</span> Board</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建新的 board 对象</span></span><br><span class="line">In [<span class="number">3</span>]: board = Board(name=<span class="string">'Django'</span>,description=<span class="string">'this is a board about Django.'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将这个对象保存在数据库中 调用 save方法 用于创建和更新对象</span></span><br><span class="line">In [<span class="number">4</span>]: board.save()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在保存之前实例是没有 id 的，第一次保存后 Django 会自动设置 ID</span></span><br><span class="line">In [<span class="number">5</span>]: board.id</span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将其余的字段当做 Python 属性访问</span></span><br><span class="line">In [<span class="number">6</span>]: board.name</span><br><span class="line">Out[<span class="number">6</span>]: <span class="string">'Django'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: board.description</span><br><span class="line">Out[<span class="number">7</span>]: <span class="string">'this is a board about Django.'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新数据库的数据</span></span><br><span class="line">In [<span class="number">8</span>]: board.descripion = <span class="string">'Django discussion board.'</span></span><br><span class="line">In [<span class="number">9</span>]: board.save()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个 Django 模型都带有一个特殊的属性；我们称之为 Model Manager</span></span><br><span class="line"><span class="comment"># 你可以通过属性 objects 来访问这个管理器</span></span><br><span class="line"><span class="comment"># 它主要用于数据库操作 ，例如我们可以使用它来直接创建一个新的 Board 对象</span></span><br><span class="line">In [<span class="number">10</span>]: board = Board.objects.create(name=<span class="string">'Python'</span>,description=<span class="string">'General discussion about python.'</span>)</span><br><span class="line">In [<span class="number">11</span>]: board.id</span><br><span class="line">Out[<span class="number">11</span>]: <span class="number">2</span></span><br><span class="line">In [<span class="number">12</span>]: board.name</span><br><span class="line">Out[<span class="number">12</span>]: <span class="string">'Python'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们存了两条数据 现在可以使用 objects 列出数据库中所有的现有版块</span></span><br><span class="line"><span class="comment"># 返回的结果是一个 QuerySet</span></span><br><span class="line">In [<span class="number">13</span>]: Board.objects.all()</span><br><span class="line">Out[<span class="number">13</span>]: &lt;QuerySet [&lt;Board: Board object (<span class="number">1</span>)&gt;, &lt;Board: Board object (<span class="number">2</span>)&gt;]&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出 Python Shell</span></span><br><span class="line">In [<span class="number">14</span>]: exit()</span><br></pre></td></tr></table></figure>
<p>在 In [13] 中我们只能看到两个对象，但显示的名称是 Board Project，这是因为我们尚未实现 Board 的 <strong>str</strong> 方法。当使用这个模块的该方法时，就会打印从这个方法中 return 的数据，当做对这个对象的描述。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">boards/models.py</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Board</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># unique= True 强调数据库级别字段的唯一性</span></span><br><span class="line">    <span class="comment"># 必须添加 default 否则会报错告诉你必须添加默认值</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">30</span>,unique=<span class="literal">True</span>,default=<span class="string">'test'</span>)</span><br><span class="line">    description = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>
<p>再次进入交互式控制台,可对比两者之间的区别</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">(base) myproject&gt;python manage.py shell</span><br><span class="line">Python <span class="number">3.7</span><span class="number">.1</span> (default, Dec <span class="number">10</span> <span class="number">2018</span>, <span class="number">22</span>:<span class="number">54</span>:<span class="number">23</span>) [MSC v<span class="number">.1915</span> <span class="number">64</span> bit (AMD64)]</span><br><span class="line">Type <span class="string">'copyright'</span>, <span class="string">'credits'</span> <span class="keyword">or</span> <span class="string">'license'</span> <span class="keyword">for</span> more information</span><br><span class="line">IPython <span class="number">7.2</span><span class="number">.0</span> -- An enhanced Interactive Python. Type <span class="string">'?'</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> boards.models <span class="keyword">import</span> Board</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 Board 的数据</span></span><br><span class="line">In [<span class="number">3</span>]: Board.objects.all()</span><br><span class="line">Out[<span class="number">3</span>]: &lt;QuerySet [&lt;Board: Django&gt;, &lt;Board: Python&gt;]&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 Board 表中的所有数据 赋值给 boards_list</span></span><br><span class="line">In [<span class="number">4</span>]: boards_list = Board.objects.all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历列表 注意运行的方法为 Ctrl+Enter</span></span><br><span class="line">In [<span class="number">6</span>]: <span class="keyword">for</span> board <span class="keyword">in</span> boards_list:</span><br><span class="line">   ...:     print(board.description)</span><br><span class="line">   ...: </span><br><span class="line">this <span class="keyword">is</span> a board about Django.</span><br><span class="line">General discussion about python.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取单个数据 通过 get 方法</span></span><br><span class="line"><span class="comment"># 通过 get(id=1) 来匹配</span></span><br><span class="line">In [<span class="number">7</span>]: django_board = Board.objects.get(id=<span class="number">1</span>)</span><br><span class="line">In [<span class="number">8</span>]: django_board</span><br><span class="line">Out[<span class="number">8</span>]: &lt;Board: Django&gt;</span><br><span class="line">In [<span class="number">9</span>]: django_board.name</span><br><span class="line">Out[<span class="number">9</span>]: <span class="string">'Django'</span></span><br><span class="line">In [<span class="number">10</span>]: django_board.description</span><br><span class="line">Out[<span class="number">10</span>]: <span class="string">'this is a board about Django.'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 get(name='django') 来匹配</span></span><br><span class="line">In [<span class="number">12</span>]: django_board = Board.objects.get(name=<span class="string">'django'</span>)</span><br><span class="line">In [<span class="number">13</span>]: django_board.name</span><br><span class="line">Out[<span class="number">13</span>]: <span class="string">'Django'</span></span><br></pre></td></tr></table></figure>
<h1 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h1><ul>
<li><strong>System design And Models</strong> 方面非常清晰的描述清楚了一对多的关系、并且用视图的方法更加直观的描述了各个 model 之间的关系,这在后续我们开发 Django 项目之前画一个类似的图能帮助我们更好的了解我们自己要构建的 Models。</li>
<li><strong>Wirdframes</strong> 通过原型图来了解需求是非常好的方法 如果我们在前面并不能很清晰的了解我们的需要构建的模型，在这一步也可以深入的去理解。</li>
<li><strong>Python Shell</strong> 通过 Python Shell 可以更快的了解 Models 的工作机制，因为我们在 Views 中写入的查询数据库数据的代码和在 Shell 中写的是一致的。</li>
</ul>
<p>整篇文章是从需求方面出发，剖析 Models 的构建方法。甚至为了能够更好的理解外键，将原型图也拿出来了做展示。不管是 Class Diagram 还是 Wirdframes 都是非常好的理解 Models 的例子。然后是数据迁移、Python Shell 增删改查数据表中的数据。从根本上讲清楚了 Models 配置、调试、调用，确实是不可多得的好教程。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://draw.io/" target="_blank" rel="noopener">Draw your wireframes</a></li>
<li><a href="https://www.cnblogs.com/jjzz1234/p/11607793.html" target="_blank" rel="noopener">Django-ORM 之 ForeignKey 的多对一关系</a></li>
</ul>

      </div>
      
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/Django/">Django</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2020/03/23/12-A Complete Beginner`s Guide to Django -- Other`s Fundamentals/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">A Complete Beginner`s Guide to Django -- Other parts of principle</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    <a class="next" href="/2020/03/23/10-A Complete Beginner`s Guide to Django——What is Django/">
        <span class="next-text nav-default">A Complete Beginner`s Guide to Django——What is Django ?</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:afrunk7@gmail.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/afrunk" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2019 - 2020<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Afrunk</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
